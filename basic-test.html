<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indian Mutual Fund Analytics Platform</title>
<meta name="description" content="SEBI-style Mutual Fund analytics platform with SIP, rolling returns, risk metrics, and Nifty 50 benchmarking." />
<meta name="keywords" content="Mutual Fund India, SIP Calculator, MF Analyzer, Nifty 50" />
<meta name="robots" content="index, follow" />
<link rel="manifest" href="manifest.json" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--accent:#2563eb;--bg:#f8fafc;--card:#fff}
body{font-family:Arial;margin:0;background:var(--bg)}
header{background:var(--accent);color:#fff;padding:16px}
.container{max-width:1200px;margin:auto;padding:16px}
.card{background:var(--card);padding:16px;margin-bottom:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
input,select{padding:6px;width:100%;margin-bottom:8px}
.mode{float:right}
</style>
</head>
<body>
<header>
<h2>ğŸ“ˆ Indian Mutual Fund Analytics</h2>
<select id="userMode" class="mode" onchange="switchMode()">
<option value="investor">Investor</option>
<option value="advisor">Advisor</option>
<option value="public">Public Analytics</option>
</select>
</header>

<div class="container">

<div class="card">
<h3>ğŸ’¼ Advisor Branding</h3>
<input id="brandName" placeholder="Advisor / Brand Name">
<input id="brandColor" placeholder="Primary Color (#hex)">
<button onclick="applyBranding()">Apply Branding</button>
</div>

<div class="card">
<h3>User Login (Soft Auth)</h3>
<input id="uname" placeholder="Enter name" />
<button onclick="login(uname.value)">Login</button>
<button onclick="logout()">Logout</button>
<p id="userInfo"></p>
</div>

<div class="card">
  <h3>ğŸ“Š MF Screener</h3>
  <select id="fCategory">
    <option value="">All Categories</option>
    <option>Equity Large Cap</option>
    <option>Equity Mid Cap</option>
  </select>

  <input id="fReturn" placeholder="Min 3Y Return %" />
  <input id="fRisk" placeholder="Max Volatility %" />
  <button onclick="runScreener()">Filter</button>

  <div id="screenResults"></div>
</div>

<div class="card">
<h3>Mutual Fund Selection</h3>
<input id="mfSearch" placeholder="Search MF scheme" oninput="searchMF()" />
<div id="mfResults"></div>
</div>

<div class="card">
<h3>ğŸ“Š MF vs Nifty 50</h3>
<canvas id="chart"></canvas>
</div>

<div class="card">
<h3>ğŸ·ï¸ SEBI Risk-o-Meter</h3>
<img id="riskSvg" src="risk-moderate.svg" width="100%" />
</div>

<div class="card">
<h3>ğŸ“Š SIP vs Lump Sum</h3>
<input id="sipAmt" placeholder="Monthly SIP Amount" />
<button onclick="calcSIP()">Simulate</button>
<p id="sipResult"></p>
</div>

<div class="card">
<h3>ğŸ“ Portfolio Upload</h3>
<textarea id="portfolio" placeholder="MFCode,Amount,Date"></textarea>
<button onclick="calcXIRR()">Calculate XIRR</button>
<p id="xirr"></p>
</div>

<div class="card">
<h3>Upload Portfolio CSV</h3>
<input type="file" id="portfolioFile">
<div id="portfolioResult"></div>
</div>

<div class="card">
<h3>Monte Carlo Simulation</h3>
<button onclick="runMonteCarlo()">Run Simulation</button>
<canvas id="mcChart"></canvas>
</div>

<div class="card">
<h3>XIRR Calculator</h3>
<textarea id="cashflows" placeholder="date,amount per line"></textarea>
<button onclick="calcXIRR()">Calculate XIRR</button>
<p id="xirrResult"></p>
</div>

<div class="card">
<h3>ğŸ“œ SEBI Disclaimer</h3>
<p style="font-size:12px">
Mutual Fund investments are subject to market risks. Past performance is not indicative of future returns. This platform is for educational purposes only and does not constitute investment advice.
</p>
</div>

<div class="card">
<h3>ğŸ“„ Export</h3>
<button onclick="exportPDF()">Download PDF Factsheet</button>
<button onclick="shareLink()">Share Analysis</button>
</div>

</div>

<script>

// ---------------- CONFIG ----------------
const AMFI_BASE="https://raw.githubusercontent.com/system4trading/mf-data-cache/tree/main/amfi/";
const NIFTY_URL="https://raw.githubusercontent.com/system4trading/mf-data-cache/blob/main/nifty/nifty50.json";
const CATEGORY_AVG_URL="https://raw.githubusercontent.com/system4trading/mf-data-cache/blob/main/category_avg.json";

let brand={name:"",color:"#1d4ed8"};

// ---------------- BRANDING ----------------
function applyBranding(){
 brand.name=brandName.value;
 brand.color=brandColor.value||brand.color;
 document.documentElement.style.setProperty('--accent',brand.color);
 document.title=brand.name?brand.name+" MF Analytics":"Indian MF Analytics";
}

// -------- DEMO DATASET --------
const mfDB=[{name:"Demo Equity Fund",symbol:"DEMO.NS",category:"Equity Large Cap"}];

// -------- SOFT AUTH --------
let currentUser=localStorage.getItem('mf_user');
if(currentUser) userInfo.textContent='Logged in as '+currentUser;
function login(n){localStorage.setItem('mf_user',n);location.reload();}
function logout(){localStorage.removeItem('mf_user');location.reload();}

// -------- USER MODE --------
function switchMode(){
 const m=userMode.value;
 document.body.style.opacity=m==='public'?0.95:1;
}

// ---------------- DATA ----------------
let mfMaster=[{schemeCode:"120503",name:"Demo Equity Fund",category:"Equity Large Cap",aum:15000,expense:0.95}];
let categoryAvg={"Equity Large Cap":{1:0.12,3:0.14,5:0.15}};

// -------- MF SEARCH --------
function searchMF(){
 mfResults.innerHTML='';
 const q=mfSearch.value.toLowerCase();
 mfDB.filter(x=>x.name.toLowerCase().includes(q)).forEach(x=>{
  const d=document.createElement('div');
  d.textContent=x.name+' ('+x.symbol+')';
  d.onclick=()=>loadMF(x);
  mfResults.appendChild(d);
 });
}

// ---------------- FINANCE UTILS ----------------
const returns=p=>p.slice(1).map((v,i)=>Math.log(v/p[i]));
const mean=a=>a.reduce((x,y)=>x+y,0)/a.length;
const stdev=a=>Math.sqrt(mean(a.map(x=>(x-mean(a))**2)));

function downsideDev(r){return Math.sqrt(mean(r.filter(x=>x<0).map(x=>x*x)));}
function sharpe(r){return mean(r)/stdev(r)*Math.sqrt(252);}
function sortino(r){return mean(r)/downsideDev(r)*Math.sqrt(252);}
function beta(rf,rb){return mean(rf.map((r,i)=>r*rb[i]))/(stdev(rb)**2);}
function alpha(rf,rb){return mean(rf)-beta(rf,rb)*mean(rb);}

// -------- LOAD MF (DEMO) --------
function loadMF(mf){
 const ctx=document.getElementById('chart');
 new Chart(ctx,{type:'line',data:{labels:[1,2,3],datasets:[{label:mf.name,data:[100,120,140]}]}});
 updateRiskMeter(0.18);
}

// ---------------- LOAD & ANALYZE ----------------
async function loadMF(mf){
 fsCat.textContent=mf.category;
 fsAum.textContent=mf.aum;
 fsExp.textContent=mf.expense+'%';

 const nav=await fetch(AMFI_BASE+`nav_${mf.schemeCode}.json`).then(r=>r.json());
 const nifty=await fetch(NIFTY_URL).then(r=>r.json());

 const navP=nav.map(x=>x.nav);
 const nifP=nifty.map(x=>x.close);

 const rM=returns(navP), rN=returns(nifP);

 fsSharpe.textContent=sharpe(rM).toFixed(2);
 fsSortino.textContent=sortino(rM).toFixed(2);
 fsBeta.textContent=beta(rM,rN).toFixed(2);
 fsAlpha.textContent=(alpha(rM,rN)*252*100).toFixed(2)+'%';

 plotCharts(nav,nifty,rM,rN);
 rollingTable(navP,mf.category);
 updateRisk(stdev(rM)*Math.sqrt(252));
}

// ---------------- CHARTS ----------------
function plotCharts(nav,nifty,rM,rN){
 new Chart(priceChart,{type:'line',data:{labels:nav.map(x=>x.date),datasets:[{label:'MF NAV',data:nav.map(x=>x.nav)},{label:'Nifty 50',data:nifty.map(x=>x.close)}]}});

 let rollSharpe=[]; let rollBeta=[]; let win=252;
 for(let i=win;i<rM.length;i++){
  rollSharpe.push(sharpe(rM.slice(i-win,i)));
  rollBeta.push(beta(rM.slice(i-win,i),rN.slice(i-win,i)));
 }
 new Chart(riskChart,{type:'line',data:{labels:rollSharpe.map((_,i)=>i),datasets:[{label:'Rolling Sharpe',data:rollSharpe},{label:'Rolling Beta',data:rollBeta}]}});
}

// ---------------- ROLLING TABLE ----------------
function cagr(p,y){return (p[p.length-1]/p[p.length-1-y*252])**(1/y)-1}
function rollingTable(p,cat){
 r1y.textContent=(cagr(p,1)*100).toFixed(2)+'%';
 r3y.textContent=(cagr(p,3)*100).toFixed(2)+'%';
 r5y.textContent=(cagr(p,5)*100).toFixed(2)+'%';
 c1y.textContent=(categoryAvg[cat][1]*100)+'%';
 c3y.textContent=(categoryAvg[cat][3]*100)+'%';
 c5y.textContent=(categoryAvg[cat][5]*100)+'%';
}

// -------- RISK --------
function updateRiskMeter(v){
 let lvl='moderate';
 if(v>0.25) lvl='very-high';
 riskSvg.src='risk-'+lvl+'.svg';
}

// -------- SIP --------
function calcSIP(){
 const a=+sipAmt.value; sipResult.textContent='Estimated Value: '+(a*12*5);
}

// -------- XIRR (DEMO) --------
function calcXIRR(){ xirr.textContent='XIRR: 12.4%'; }

// -------- PORTFOLIO UPLOAD ---------
document.getElementById('portfolioFile').addEventListener('change', e => {
 const file = e.target.files[0];
 const reader = new FileReader();
 reader.onload = () => {
  const rows = reader.result.split('\n').slice(1);
  let total = 0;
  rows.forEach(r => { const v = r.split(','); total += Number(v[2]||0); });
  document.getElementById('portfolioResult').textContent = 'Total Investment: â‚¹'+total.toFixed(2);
 };
 reader.readAsText(file);
});

// -------- MONTE CARLO ---------
function runMonteCarlo(){
 const years=10, sims=200;
 let paths=[];
 for(let s=0;s<sims;s++){
  let v=1, arr=[];
  for(let i=0;i<years;i++){
   v*=1+(Math.random()*0.2-0.05);
   arr.push(v);
  }
  paths.push(arr[years-1]);
 }
 const ctx=document.getElementById('mcChart').getContext('2d');
 new Chart(ctx,{type:'histogram',data:{labels:paths, datasets:[{label:'Ending Value',data:paths}]}});
}

// -------- XIRR ---------
function calcXIRR(){
 const lines=document.getElementById('cashflows').value.trim().split('\n');
 let flows=lines.map(l=>{const p=l.split(',');return {d:new Date(p[0]),v:Number(p[1])}});
 function npv(rate){return flows.reduce((a,f)=>a+f.v/Math.pow(1+rate,(f.d-flows[0].d)/31536000000),0)}
 let r=0.1;
 for(let i=0;i<100;i++){r-=npv(r)/1000}
 document.getElementById('xirrResult').textContent='XIRR: '+(r*100).toFixed(2)+'%';
}

// -------- EXPORT --------
function exportPDF(){ alert('PDF generated (demo)'); }
function shareLink(){ navigator.clipboard.writeText(location.href); alert('Link copied'); }

// -------- PWA --------
if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js');}
</script>
</body>
</html>
